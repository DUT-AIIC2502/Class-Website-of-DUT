<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>智创2502班·学生信息</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='CSS/style_home.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='CSS/style_select_choose.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='CSS/style_info_management.css') }}">
    <script>
    document.addEventListener('DOMContentLoaded', function() {
      // 获取DOM元素
      const dropdownTrigger = document.getElementById('dropdownTrigger');
      const dropdownPanel = document.getElementById('dropdownPanel');
      const dropdownArrow = document.getElementById('dropdownArrow');
      const selectedText = document.getElementById('selectedText');
      const checkboxes = document.querySelectorAll('.dropdown__checkbox:not(#selectAll)');
      const selectAllCheckbox = document.getElementById('selectAll');
      const confirmBtn = document.getElementById('confirmBtn');
      const cancelBtn = document.getElementById('cancelBtn');
      const searchInput = document.getElementById('searchInput');
      const selectionResult = document.getElementById('selectionResult');
      const selectedItems = document.getElementById('selectedItems');

      // 打开/关闭下拉面板
      dropdownTrigger.addEventListener('click', function() {
        if (!dropdownPanel.classList.contains('dropdown__panel--open')) {
          // 打开下拉面板
          dropdownPanel.classList.add('dropdown__panel--open');
          dropdownArrow.classList.add('dropdown__arrow--rotated');
          searchInput.focus();
        } else {
          // 关闭下拉面板
          closeDropdown();
        }
      });

      // 关闭下拉面板的函数
      function closeDropdown() {
        dropdownPanel.classList.remove('dropdown__panel--open');
        dropdownArrow.classList.remove('dropdown__arrow--rotated');
      }

      // 点击外部关闭下拉面板
      document.addEventListener('click', function(event) {
        if (!dropdownTrigger.contains(event.target) && !dropdownPanel.contains(event.target)) {
          closeDropdown();
        }
      });

      // 全选/取消全选功能
      selectAllCheckbox.addEventListener('change', function() {
        const isChecked = this.checked;
        checkboxes.forEach(checkbox => {
          checkbox.checked = isChecked;
        });
        updateSelectedText();
      });

      // 单个复选框变更事件
      checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          updateSelectAllStatus();
          updateSelectedText();
        });
      });

      // 更新全选框状态
      function updateSelectAllStatus() {
        const checkedCount = document.querySelectorAll('.dropdown__checkbox:not(#selectAll):checked').length;
        selectAllCheckbox.checked = checkboxes.length > 0 && checkedCount === checkboxes.length;
        selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < checkboxes.length;
      }

      // 更新选中项文本显示
      function updateSelectedText() {
        const checkedItems = Array.from(checkboxes)
          .filter(checkbox => checkbox.checked)
          .map(checkbox => checkbox.value);

        if (checkedItems.length > 0) {
          selectedText.textContent = `${checkedItems.length} 项已选择`;
          selectedText.classList.add('dropdown__selected-text--has-selection');
        } else {
          selectedText.textContent = '请选择...';
          selectedText.classList.remove('dropdown__selected-text--has-selection');
        }
      }

      // 搜索过滤功能
      searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();

        checkboxes.forEach(checkbox => {
          const label = checkbox.nextElementSibling;
          const itemText = label.textContent.toLowerCase();
          const parentItem = checkbox.closest('.dropdown__option');

          if (itemText.includes(searchTerm)) {
            parentItem.style.display = 'flex';
          } else {
            parentItem.style.display = 'none';
          }
        });

        // 处理选项组显示逻辑
        const optionGroups = document.querySelectorAll('.dropdown__group');
        optionGroups.forEach(group => {
          const visibleItems = group.querySelectorAll('.dropdown__option[style="display: flex;"]');
          const groupHeader = group.querySelector('.dropdown__group-header');

          if (visibleItems.length > 0) {
            group.style.display = 'block';
            groupHeader.style.display = 'block';
          } else {
            // 如果搜索词为空，显示整个组；否则隐藏
            if (searchTerm === '') {
              group.style.display = 'block';
              groupHeader.style.display = 'block';
            } else {
              group.style.display = 'none';
            }
          }
        });
      });

      // 确认按钮点击事件
      confirmBtn.addEventListener('click', function() {
        const checkedItems = Array.from(checkboxes)
          .filter(checkbox => checkbox.checked)
          .map(checkbox => checkbox.value);

        // 更新选择结果显示
        selectedItems.innerHTML = '';
        if (checkedItems.length > 0) {
          selectionResult.classList.add('selection-result--visible');
          checkedItems.forEach(item => {
            const badge = document.createElement('span');
            badge.className = 'selection-result__badge';
            badge.textContent = item;
            selectedItems.appendChild(badge);
          });
        } else {
          selectionResult.classList.remove('selection-result--visible');
        }

        closeDropdown();
      });

      // 取消按钮点击事件
      cancelBtn.addEventListener('click', closeDropdown);

      // 初始化
      updateSelectAllStatus();
    });
    </script>
</head>
<body>
    <!-- 导航栏 -->
    <header>
        <div class="container header-container">
            <div class="logo">
                <i class="fas fa-rocket"></i>
                <h1>智创<span>2502班</span></h1>
            </div>

            <nav>
                <ul>
                    {% for url in navbar_urls %}
                        <li><a href="{{ url.0 }}">{{ url.1 }}</a></li>
                    {% endfor %}
                </ul>
            </nav>

            {% if user_id %}
                <div>
                    <a href="/auth/detail_info" class="user-info">
                        <img src="{{ url_for('static', filename='images/icon_user.png') }}"
                             alt="用户头像" width="50" height="50">
                        <p class="user-name">{{ user_name }}</p>
                        <p class="user-role">{{ user_top_role }}</p>
                    </a>
                </div>
            {% else %}
                <div class="nav-btns">
                    <a href="/auth/login/" class="btn btn-outline">登录</a>
                    <a href="/auth/register/" class="btn btn-primary">注册</a>
                </div>
            {% endif %}
        </div>
    </header>

    <div class="container">
<!--        &lt;!&ndash; 导航页面 &ndash;&gt;-->
<!--        <div class="navbar">-->
<!--            <div class="nav-brand">信息管理系统</div>-->
<!--            <ul class="nav-links">-->
<!--                <li><a href="/home/">首页</a></li>-->
<!--            </ul>-->
<!--        </div>-->

        <h1>智创2502班·学生信息</h1>

        <!-- 使用说明板块 -->
        <div class="instructions">
            <h3>使用说明</h3>
            <p>1. 输入姓名/学号/（空）</p>
            <p>2. 在复选框中选择需要查询的字段</p>
            <p>3. 点击"查询"按钮即可查询需要的信息</p>
            <p>提示：如需获取最新数据，不能仅仅刷新页面，而是需要再次查询</p>
        </div>

        <!-- 表单板块 -->
        <div class="card">
            <form method="post" action="/info_management/">
                <h2>查询信息</h2>
                <div class="form-group">
                    <!-- 输入姓名 -->
                    <label for="name">学生姓名：</label>
                    <input type="text" id="name" name="name" value="{{ name }}" placeholder="请输入学生姓名">
                </div>
                <div class="form-group">
                    <!-- 输入学号 -->
                    <label for="student_id">学号：</label>
                    <input type="number" id="student_id" name="student_id" value="{{ student_id }}" placeholder="请输入11位整数学号">
                </div>
                <div class="form-group">
                    <!-- 选择需要特异性查询的字段，并输入需要查询的值 -->
                    <h4>条件查询</h4>
                    <select id="filter_field" name="filter_field">
                        {% for row in fields %}
                            <option value={{row.0}} {{row.3}}>{{row.1}}</option>
                        {% endfor %}
                    </select>
                    <input type="text" id="filter_field_value"
                           name="filter_field_value" value="{{ filter_field_value }}"
                           placeholder="请输入想查询的值">
                </div>

                <hr>

<!--                 &lt;!&ndash; 下拉复选框组件 &ndash;&gt;-->
<!--                <div class="dropdown">-->
<!--                    &lt;!&ndash; 触发按钮 &ndash;&gt;-->
<!--                    <button class="dropdown__trigger" id="dropdownTrigger" type="button">-->
<!--                        <span class="dropdown__selected-text" id="selectedText">请选择...</span>-->
<!--                        <svg class="dropdown__arrow" id="dropdownArrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">-->
<!--                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>-->
<!--                        </svg>-->
<!--                    </button>-->

<!--                    &lt;!&ndash; 下拉面板 &ndash;&gt;-->
<!--                    <div class="dropdown__panel" id="dropdownPanel">-->
<!--                        &lt;!&ndash; 搜索框 &ndash;&gt;-->
<!--                        <div class="dropdown__search">-->
<!--                            <input type="text" class="dropdown__search-input" id="searchInput" placeholder="搜索选项...">-->
<!--                        </div>-->
<!--                    </div>-->

<!--                    &lt;!&ndash; 选项列表 &ndash;&gt;-->
<!--                    <div class="dropdown__options" id="optionsContainer">-->
<!--                        &lt;!&ndash; 全选/取消全选 &ndash;&gt;-->
<!--                        <div class="dropdown__option">-->
<!--                            <input type="checkbox" class="dropdown__checkbox" id="selectAll">-->
<!--                            <label class="dropdown__label" for="selectAll">全选/取消全选</label>-->
<!--                        </div>-->

<!--                        &lt;!&ndash; 分隔线 &ndash;&gt;-->
<!--                        <div class="dropdown__divider"></div>-->

<!--                        &lt;!&ndash; 选项组：前端语言 &ndash;&gt;-->
<!--                        <div class="dropdown__group">-->
<!--                            <div class="dropdown__group-header">前端语言</div>-->
<!--                            <div class="dropdown__group-options">-->
<!--                                <div class="dropdown__option">-->
<!--                                    <input type="checkbox" class="dropdown__checkbox" id="opt1" value="JavaScript">-->
<!--                                    <label class="dropdown__label" for="opt1">JavaScript</label>-->
<!--                                </div>-->
<!--                                <div class="dropdown__option">-->
<!--                                    <input type="checkbox" class="dropdown__checkbox" id="opt2" value="TypeScript">-->
<!--                                    <label class="dropdown__label" for="opt2">TypeScript</label>-->
<!--                                </div>-->
<!--                                <div class="dropdown__option">-->
<!--                                    <input type="checkbox" class="dropdown__checkbox" id="opt3" value="HTML/CSS">-->
<!--                                    <label class="dropdown__label" for="opt3">HTML/CSS</label>-->
<!--                                </div>-->
<!--                            </div>-->
<!--                        </div>-->

<!--                         &lt;!&ndash; 选项组：后端语言 &ndash;&gt;-->
<!--                        <div class="dropdown__group">-->
<!--                            <div class="dropdown__group-header">后端语言</div>-->
<!--                            <div class="dropdown__group-options">-->
<!--                                <div class="dropdown__option">-->
<!--                                    <input type="checkbox" class="dropdown__checkbox" id="opt4" value="Python">-->
<!--                                    <label class="dropdown__label" for="opt4">Python</label>-->
<!--                                 </div>-->
<!--                                <div class="dropdown__option">-->
<!--                                    <input type="checkbox" class="dropdown__checkbox" id="opt5" value="Java">-->
<!--                                    <label class="dropdown__label" for="opt5">Java</label>-->
<!--                                </div>-->
<!--                                <div class="dropdown__option">-->
<!--                                    <input type="checkbox" class="dropdown__checkbox" id="opt6" value="Go">-->
<!--                                    <label class="dropdown__label" for="opt6">Go</label>-->
<!--                                </div>-->
<!--                            </div>-->
<!--                        </div>-->

<!--                        &lt;!&ndash; 显示选择结果 &ndash;&gt;-->
<!--                        <div class="selection-result" id="selectionResult">-->
<!--                            <h4 class="selection-result__title">您已选择：</h4>-->
<!--                            <div class="selection-result__items" id="selectedItems"></div>-->
<!--                        </div>-->
<!--                    </div>-->
<!--                </div>-->

                <div class="form-group">
                    <h3>选择要展示的字段：</h3>
                    <!-- 输出该表中所有字段，并默认标记某些字段 -->
                    {% for row in fields %}
                        <label class="checkbox-container">{{row.1}}
                            {% if row.0 == 'name' or row.0 == 'student_id' %}
                                <input type="checkbox" name="field_to_show" value={{row.0}} {{row.2}}
                                       onclick="return false;">
                            {% else %}
                                <input type="checkbox" name="field_to_show" value={{row.0}} {{row.2}}>
                            {% endif %}
                            <span class="checkmark"></span>
                        </label>
                    {% endfor %}
                </div>

                <!-- 查询按钮 -->
                <div class="form-group">
                    <button class="btn btn-primary" name="method" value="select">查询</button>
                </div>

                <hr>

                <!-- 导入/导出操作 -->
                <div class="form-group">
                    <h3>导入/导出excel</h3>
                    <button class="btn btn-primary" name="method" value="import">导入</button>
                    <button class="btn btn-primary" name="method" value="export">导出</button>
                </div>
            </form>
        </div>

        <!-- 输出结果板块 -->
        {% if table %}
            <div class="card">
                <h2>查询结果</h2>
                <form method="post" action="/info_management/">

                    <div class="form-group">
                        <button class="btn btn-primary" name="method" value="insert_info">添加一条信息</button>
                        <button class="btn btn-primary" name="method" value="insert_field">添加新的字段</button>
                        <button class="btn btn-danger" name="method" value="delete_field">选择字段删除</button>
                        <button class="btn btn-danger" name="method" value="delete">删除选中项</button>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th></th>
                                {% for f in field_selected %}
                                    <th>{{ f }}</th>
                                {% endfor %}
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row_value in table %}
                                <tr>
                                    <td>
                                        <label class="checkbox-container">
                                            <input type="checkbox" name="info_to_delete" value={{row_value.0}}>
                                            <span class="checkmark"></span>
                                        </label>
                                    </td>
                                    {% for value in row_value %}
                                        <td>{{ value }}</td>
                                    {% endfor %}
                                    <td>
                                        <button class="btn btn-primary" name="method"
                                                value="detail_{{row_value.0}}">详情</button>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <p id="pages">第{{ page_current }}/{{ page_number }}页</p>
                    <button class="btn btn-primary" name="method" value="last_page">上一页</button>
                    <button class="btn btn-primary" name="method" value="next_page">下一页</button>
                </form>

            </div>
        {% endif %}
    </div>
</body>
</html>
